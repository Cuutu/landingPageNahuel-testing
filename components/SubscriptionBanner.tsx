import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Clock, AlertTriangle, CheckCircle, RefreshCw, X } from 'lucide-react';
import styles from '@/styles/SubscriptionBanner.module.css';

interface SubscriptionBannerProps {
  service: 'TraderCall' | 'SmartMoney';
}

interface SubscriptionInfo {
  expiryDate: string;
  daysLeft: number;
  isActive: boolean;
}

export default function SubscriptionBanner({ service }: SubscriptionBannerProps) {
  const [subscriptionInfo, setSubscriptionInfo] = useState<SubscriptionInfo | null>(null);
  const [loading, setLoading] = useState(true);
  const [dismissed, setDismissed] = useState(false);

  useEffect(() => {
    fetchSubscriptionInfo();
  }, [service]);

  const fetchSubscriptionInfo = async () => {
    try {
      setLoading(true);
      const response = await fetch('/api/user/subscriptions');
      
      if (response.ok) {
        const data = await response.json();
        const activeSubs = data.activeSubscriptions || [];
        
        // Buscar la suscripci√≥n del servicio actual
        const currentSub = activeSubs.find(
          (sub: any) => sub.service === service && sub.status === 'active'
        );

        if (currentSub) {
          const now = new Date();
          const expiryDate = new Date(currentSub.expiryDate);
          const diffTime = expiryDate.getTime() - now.getTime();
          const daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

          setSubscriptionInfo({
            expiryDate: currentSub.expiryDate,
            daysLeft,
            isActive: daysLeft > 0
          });
        } else {
          setSubscriptionInfo(null);
        }
      }
    } catch (error) {
      console.error('Error cargando informaci√≥n de suscripci√≥n:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleRenew = async () => {
    try {
      // console.log('üîÑ Iniciando renovaci√≥n para:', service);
      
      // Llamar al endpoint de renovaci√≥n para crear el checkout
      const response = await fetch('/api/payments/mercadopago/create-renewal-checkout', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ service })
      });

      if (!response.ok) {
        throw new Error('Error al crear checkout de renovaci√≥n');
      }

      const data = await response.json();

      if (data.success && data.checkoutUrl) {
        // console.log('‚úÖ Redirigiendo al checkout de MercadoPago');
        // Redirigir al checkout de MercadoPago
        window.location.href = data.checkoutUrl;
      } else {
        throw new Error('No se pudo obtener URL de checkout');
      }
    } catch (error) {
      console.error('‚ùå Error al renovar suscripci√≥n:', error);
      alert('Error al procesar la renovaci√≥n. Por favor intenta nuevamente.');
    }
  };

  const handleDismiss = () => {
    setDismissed(true);
  };

  if (loading || !subscriptionInfo || dismissed) {
    return null;
  }

  const { daysLeft, expiryDate } = subscriptionInfo;
  const isExpiringSoon = daysLeft <= 7;
  const isExpired = daysLeft <= 0;

  const getIcon = () => {
    if (isExpired) return <X size={20} />;
    if (isExpiringSoon) return <AlertTriangle size={20} />;
    return <CheckCircle size={20} />;
  };

  const getMessage = () => {
    if (isExpired) {
      return 'Tu suscripci√≥n ha expirado';
    }
    if (daysLeft === 1) {
      return 'Tu suscripci√≥n expira ma√±ana';
    }
    if (daysLeft <= 3) {
      return `Tu suscripci√≥n expira en ${daysLeft} d√≠as`;
    }
    if (daysLeft <= 7) {
      return `Quedan ${daysLeft} d√≠as de suscripci√≥n`;
    }
    return `Suscripci√≥n activa ‚Ä¢ ${daysLeft} d√≠as restantes`;
  };

  const getBannerClass = () => {
    if (isExpired) return styles.bannerExpired;
    if (isExpiringSoon) return styles.bannerWarning;
    return styles.bannerActive;
  };

  return (
    <AnimatePresence>
      <motion.div
        className={`${styles.banner} ${getBannerClass()}`}
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        exit={{ opacity: 0, y: -20 }}
        transition={{ duration: 0.3 }}
      >
        <div className={styles.bannerContent}>
          <div className={styles.bannerIcon}>
            {getIcon()}
          </div>
          
          <div className={styles.bannerMessage}>
            <span className={styles.mainMessage}>{getMessage()}</span>
            {!isExpired && (
              <span className={styles.expiryDate}>
                Vence el {new Date(expiryDate).toLocaleDateString('es-AR', {
                  day: 'numeric',
                  month: 'long',
                  year: 'numeric'
                })}
              </span>
            )}
          </div>

          {(isExpiringSoon || isExpired) && (
            <button
              onClick={handleRenew}
              className={styles.renewButton}
            >
              <RefreshCw size={16} />
              Renovar
            </button>
          )}

          <button
            onClick={handleDismiss}
            className={styles.dismissButton}
            aria-label="Cerrar"
          >
            <X size={16} />
          </button>
        </div>

        {isExpiringSoon && !isExpired && (
          <div className={styles.tip}>
            üí° Si renov√°s ahora, tu tiempo actual se mantendr√° y se agregar√°n 30 d√≠as m√°s
          </div>
        )}
      </motion.div>
    </AnimatePresence>
  );
}

